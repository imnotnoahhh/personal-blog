<script>
    // Function to add copy buttons
    function addCopyButtons() {
        // Select all code blocks
        const codeBlocks = document.querySelectorAll("pre");

        codeBlocks.forEach((codeBlock) => {
            // Check if button already exists (to prevent duplicates on View Transitions)
            if (codeBlock.parentNode?.querySelector(".copy-code-btn")) return;

            // Create the copy button
            const copyButton = document.createElement("button");
            copyButton.className =
                "copy-code-btn absolute top-2 right-2 p-2 bg-zinc-800 text-zinc-400 hover:text-white rounded-md transition-colors opacity-0 group-hover:opacity-100 focus:opacity-100";
            copyButton.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
          <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
        </svg>
      `;
            copyButton.ariaLabel = "Copy code";

            // Wrap the code block in a relative container if not already
            const wrapper = document.createElement("div");
            wrapper.className = "relative group";

            // Insert wrapper
            codeBlock.parentNode?.insertBefore(wrapper, codeBlock);
            wrapper.appendChild(codeBlock);
            wrapper.appendChild(copyButton);

            // Add click event
            copyButton.addEventListener("click", async () => {
                const code =
                    codeBlock.querySelector("code")?.innerText ||
                    codeBlock.innerText;

                try {
                    await navigator.clipboard.writeText(code);

                    // Show "Copied" state
                    const originalIcon = copyButton.innerHTML;
                    copyButton.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="20 6 9 17 4 12"></polyline>
            </svg>
          `;

                    setTimeout(() => {
                        copyButton.innerHTML = originalIcon;
                    }, 2000);
                } catch (err) {
                    console.error("Failed to copy: ", err);
                }
            });
        });
    }

    // Run on initial load
    addCopyButtons();

    // Run on View Transitions navigation
    document.addEventListener("astro:page-load", addCopyButtons);
</script>
